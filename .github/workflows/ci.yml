name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Добавляем права на запись

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ make lcov python3-pip
        pip install gcovr

    - name: Build main program
      run: make

    - name: Build and run tests
      run: |
        make test
        ./run_tests

    - name: Run tests with coverage
      run: |
        make coverage-gcovr

    - name: Check coverage threshold
      run: |
        gcovr -r . --filter="src/.*" --exclude=".*test.*" --fail-under-line 65

    - name: Extract coverage percentage
      id: coverage
      run: |
        COVERAGE=$(gcovr -r . --filter="src/.*" --exclude=".*test.*" --print-summary | grep -oP "lines: \K[0-9.]+" | head -1)
        echo "COVERAGE_PERCENT=$COVERAGE" >> $GITHUB_ENV
        echo "Coverage: $COVERAGE%"

    - name: Generate coverage badge
      run: |
        pip install anybadge
        anybadge --label=coverage --value=${{ env.COVERAGE_PERCENT }}% --file=coverage.svg --color=green

    - name: Commit coverage badge to repository
      if: github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add coverage.svg
        git commit -m "Update coverage badge: ${{ env.COVERAGE_PERCENT }}%" || exit 0
        git push